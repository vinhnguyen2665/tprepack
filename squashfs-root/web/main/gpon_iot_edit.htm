<style type="text/css">
select.L
{
	width:130px;
}
</style>
<script type="text/javascript" language="javascript">

var IOT_ATTR_NUMBER = "0";
var IOT_ATTR_ARRAY = "1";
var IOT_ATTR_BOOLEAN = "2";

var IOT_ATTR_LEN_MAX = 30;

var ME_INST_ID_MIN = 0;
var ME_INST_ID_MAX = 65536;

var ME_INST_DESC_LEN_MAX = 63;

var THIS_PAGE = "gpon_iot_edit.htm";
var PREV_PAGE = "device_mgmt.htm";

/* String constants */
var STR_BTN_SAVE = "Save";
var STR_BTN_ADD = "Add";
var STR_BTN_DEL = "Delete";
var STR_BTN_BACK = "Back";
var STR_BTN_CANCEL = "Cancel";

var STR_NOT_AVAILABLE = "N/A";

var MSG_SAVE_OK = "Successfully saved!";
var MSG_ADD_OK = "Successfully added!";
var MSG_DEL_OK = "Successfully deleted!";
var MSG_DEL_CONFIRM = "Are you sure to delete the IOT config of this instance?";
var MSG_CUR_ME_IOT_CHANGED = "You have modified the IOT config of current instance, please first save it!";
var MSG_BACK_CONFIRM = "You have modified the IOT config of current instance but not yet save it, sure to leave?";
var MSG_HAS_ERR_BEFORE_SAVE = "Some empty or illegal input detected, please check it!";
var MSG_HAS_ERR_BEFORE_ADD = "Some empty or illegal input detected, please check it!";
var MSG_ME_INST_ID_ERR = "Instance number error:";
var MSG_ME_INST_EXISTS = "Instance already exists!";
var MSG_ME_INST_DESC_TOO_LONG = "Instance description is too long!";

/* ID constants */
var ID_BTN_SAVE = "btnSave";
var ID_BTN_ADD = "btnAdd";
var ID_BTN_DEL = "btnDel";
var ID_BTN_BACK = "btnBack";

var ID_TBL_ME_INFO = "tblMeInfo";
var ID_TBL_ME_ATTR = "tblMeAttr";

var ID_ROW_ME_ATTR = "rowMeAttr";

var ID_TD_ME_ID = "tdMeId";
var ID_TD_ME_NAME = "tdMeName";
var ID_TD_ME_DESC = "tdMeDesc";

var ID_TD_ME_ATTR_ID = "tdMeAttrId";
var ID_TD_ME_ATTR_NAME = "tdMeAttrName";
var ID_TD_ME_ATTR_DESC = "tdMeAttrDesc";

var ID_TD_ME_IOT_EN = "tdMeIotEn";
var ID_TD_ME_IOT_VAL = "tdMeIotVal";

var ID_SEL_ME_INST_ID = "selMeInstId";

var ID_TXB_ME_INST_DESC = "txbMeInstDesc";

var ID_TXB_ME_INST_ID_NEW = "txbMeInstIdNew";
var ID_TXB_ME_INST_DESC_NEW = "txbMeInstDescNew";

var ID_CHKB_ME_IOT_EN = "chkbMeIotEn";
var ID_TXB_ME_IOT_VAL = "txbMeIotVal";
var ID_SEL_ME_IOT_VAL = "selMeIotVal";

var ID_PARA_ME_INST_NONE = "paraMeInstNone";
var ID_PARA_ME_INST_INFO = "paraMeInstInfo";
var ID_PARA_ME_INST_NEW = "paraMeInstNew";

var ID_DIV_ERR_MSG = "divErrMsg";

var errFlag = false;
var errEle = null;
var errAttrId = 0;

var l_dbMeIotConfigInDevInfo = null;
var ID_ME_ONU_G = 256;
var ID_ATTR_ONUG_VENDOR_ID = 0;
var ID_ATTR_ONUG_VERSION = 1;
var ID_ATTR_ONUG_SN = 2;
var ID_ATTR_ONUG_TRAFFIC_MNGT_OP = 3;

var ID_ME_ONU2_G = 257;
var ID_ATTR_ONU2G_OMCC_VER = 1;
var ID_ATTR_ONU2G_EQUIPMENT_ID = 0;

var ID_ME_SW_IMG = 7;
var ID_ATTR_SW_IMG_VER = 0;

function InitMeIotCfgInDevInfoTbl()
{
	l_dbMeIotConfigInDevInfo = new Array();
	
	var MeIot = new Object();
	MeIot.meId = ID_ME_ONU_G;
	MeIot.attrId = ID_ATTR_ONUG_VENDOR_ID;
	l_dbMeIotConfigInDevInfo.push(MeIot);

	MeIot = new Object();
	MeIot.meId = ID_ME_ONU_G;
	MeIot.attrId = ID_ATTR_ONUG_VERSION;
	l_dbMeIotConfigInDevInfo.push(MeIot);

	MeIot = new Object();
	MeIot.meId = ID_ME_ONU_G;
	MeIot.attrId = ID_ATTR_ONUG_SN;
	l_dbMeIotConfigInDevInfo.push(MeIot);

	MeIot = new Object();
	MeIot.meId = ID_ME_ONU_G;
	MeIot.attrId = ID_ATTR_ONUG_TRAFFIC_MNGT_OP;
	l_dbMeIotConfigInDevInfo.push(MeIot);

	MeIot = new Object();
	MeIot.meId = ID_ME_ONU2_G;
	MeIot.attrId = ID_ATTR_ONU2G_OMCC_VER;
	l_dbMeIotConfigInDevInfo.push(MeIot);
	
	MeIot = new Object();
	MeIot.meId = ID_ME_ONU2_G;
	MeIot.attrId = ID_ATTR_ONU2G_EQUIPMENT_ID;
	l_dbMeIotConfigInDevInfo.push(MeIot);
	
	MeIot = new Object();
	MeIot.meId = ID_ME_SW_IMG;
	MeIot.attrId = ID_ATTR_SW_IMG_VER;
	l_dbMeIotConfigInDevInfo.push(MeIot);
}

function getPos(e)
{
	var l = e.offsetLeft;
	var t = e.offsetTop;
	var w = e.offsetWidth;
	var h = e.offsetHeight;
	while (e = e.offsetParent)
	{
		l += e.offsetLeft;
		t += e.offsetTop;
	}
	
	return {left:l, top:t, width:w, height:h};
}

function showErrMsg(td, errMsg)
{
	var divErrMsg = $.id(ID_DIV_ERR_MSG);
	var pos = getPos(td);
	$.html(divErrMsg, errMsg);
	$.removeClass(divErrMsg, "nd");
	divErrMsg.style.top = pos.top + (pos.height/2) - 4 + "px";
	divErrMsg.style.left = pos.left + pos.width + 2 + "px";
}

function hideErrMsg()
{
	var divErrMsg = $.id(ID_DIV_ERR_MSG);
	$.addClass(divErrMsg, "nd");
}

function errEleFocus(ele)
{
	ele.focus();
}

function numberValidation(value, format, min, max)
{
	var errMsg = "";
	var pattern;

	if (format == "hex")
	{
		pattern = /[^a-fA-F0-9]/;
	}
	else
	{
		pattern = /\D/;
	}

	if (typeof value === "string" && value.match(pattern))
	{
		if (format == "hex")
		{
			errMsg = "bad hex!";	
		}
		else
		{
			errMsg = "bad num!";
		}
	}
	else
	{
		var val;
		if (format == "hex")
		{
			val = parseInt(value, 16);
		}
		else
		{
			val = parseInt(value, 10);	
		}
		if (isNaN(val) || (val < min || val > max))
		{
			errMsg = "range[" + min + "," + max + "]";
		}
	}
	return errMsg;
}

/* Local DB */
var ldbCurMeObj = null;
var ldbCurMeInstObj = null;
var ldbMeAttrObjs = null;
var ldbMeInstObjs = null;
var ldbMeIotObjs = null;

function ldbCurMeObj_Set(meObj){ldbCurMeObj = meObj;}
function ldbCurMeObj_Get(){return ldbCurMeObj;}

function ldbCurMeInstObj_Set(meInstObj){ldbCurMeInstObj = meInstObj;}
function ldbCurMeInstObj_Get(){return ldbCurMeInstObj;}

function ldbMeAttrObjs_Set(meAttrObjs){ldbMeAttrObjs = meAttrObjs;}
function ldbMeAttrObjs_Get(){return ldbMeAttrObjs;}

function ldbMeInstObjs_Set(meInstObjs){ldbMeInstObjs = meInstObjs;}
function ldbMeInstObjs_Get(){return ldbMeInstObjs;}

function ldbMeIotObjs_Set(meIotObjs){ldbMeIotObjs = meIotObjs;}
function ldbMeIotObjs_Get(){return ldbMeIotObjs;}

function ldbMeInstObj_GetById(meInstObjs, instId)
{
	var idx = 0;
	var meInstObj = null;
	
	for (idx = 0; idx < meInstObjs.length; idx++)
	{
		if (meInstObjs[idx].instId == instId)
		{
			meInstObj = meInstObjs[idx];
		}
	}
	
	return meInstObj;
}

function ldbMeAttrObj_GetById(meAttrObjs, attrId)
{
	var idx = 0;
	var meAttrObj = null;
	
	for (idx = 0; idx < meAttrObjs.length; idx++)
	{
		if (meAttrObjs[idx].attrId == attrId)
		{
			meAttrObj = meAttrObjs[idx];
		}
	}
	
	return meAttrObj;
}

function ldbMeIotObj_GetByAttrId(meIotObjs, attrId)
{
	var idx = 0;
	var meIotObj = null;

	for (idx = 0; idx < meIotObjs.length; idx++)
	{
		if (meIotObjs[idx].attrId == attrId)
		{
			meIotObj = meIotObjs[idx];	
		}
	}
	
	return meIotObj;
}

/* Functions */

function init()
{
	InitMeIotCfgInDevInfoTbl();
	
	initData();
	loadView();
}

function initData()
{
	initCurMeObj();
	initMeAttrObjs();
	initMeInstObjs();
	initCurMeInstObj();
	initMeIotObjs(ldbCurMeInstObj_Get());
}

function loadView()
{
	var meObj = null;
	var meInstObjs = null;
	var meAttrObjs = null;
	var meIotObjs = null;
	
	meObj = ldbCurMeObj_Get();
	meInstObjs = ldbMeInstObjs_Get();
	meAttrObjs = ldbMeAttrObjs_Get();
	meIotObjs = ldbMeIotObjs_Get();

	/*
	alert("meObj.meId = " + meObj.meId + ", meObj.meName = " + meObj.meName);
	alert("meInstObjs.length = " + meInstObjs.length);
	alert("meAttrObjs.length = " + meAttrObjs.length);
	alert("meIotObjs.length = " + meIotObjs.length);
	*/
	loadMeInfo(meObj);
	loadMeAttr(meAttrObjs);
	loadMeInst(meInstObjs);
	loadMeIot(meIotObjs);
}

function initCurMeObj()
{
	ldbCurMeObj_Set($.mainParam[0]);
}

function initCurMeInstObj()
{
	if ($.mainParam[1] != undefined)
	{
		ldbCurMeInstObj_Set($.mainParam[1]);	
	}
	else
	{
		var meInstObjs = ldbMeInstObjs_Get();
		if (null != meInstObjs && meInstObjs.length > 0)
		{
			ldbCurMeInstObj_Set(meInstObjs[0]);
		}
	}
}

function initMeAttrObjs()
{
	var attrObjs = null;
	var meObj = null;
	
	meObj = ldbCurMeObj_Get();
	attrObjs = $.act(ACT_GS, GPON_OMCI_ME_ATTR_RT, null, meObj.__stack);
	if (!$.exe())
	{
		ldbMeAttrObjs_Set(attrObjs);
	}
}

function initMeInstObjs()
{
	var instObjs = null;
	var instObjList = null;
	var meObj = null;
	
	meObj = ldbCurMeObj_Get();
	//instObjs = $.act(ACT_GS, GPON_OMCI_ME_INST, null, meObj.__stack);
	instObjs = $.act(ACT_GS, GPON_OMCI_ME_INST, null, null);
	if (!$.exe())
	{
		var instObjList = new Array();
		for (var idx = 0; idx < instObjs.length; idx++)
		{
			if (meObj.meId == instObjs[idx].meId)
			{
				var instobj = new Object();
				instobj.meId = instObjs[idx].meId;
				instobj.instId = instObjs[idx].instId;
				instobj.instDesc = instObjs[idx].instDesc;
				instobj.__stack = instObjs[idx].__stack;
				instObjList.push(instobj);
			}
		}

		ldbMeInstObjs_Set(instObjList);
	}
}

function initMeIotObjs(meInstObj)
{
	var iotObjs = null;

	if (null == meInstObj)
	{
		return;	
	}
	
	iotObjs = $.act(ACT_GS, GPON_OMCI_ME_IOT, null, meInstObj.__stack);
	if (!$.exe())
	{
		ldbMeIotObjs_Set(iotObjs);
	}
}

function meIotObjsChanged(meIotObjs, enabledIots, disabledIots)
{
	var idx = 0;
	var meObj = null;
	var meIotObj = null;
	
	var meInstObj = null;
	
	meObj = ldbCurMeObj_Get();
	meInstObj = ldbCurMeInstObj_Get();
	
	for (idx = 0; idx < disabledIots.length; idx++)
	{
		meIotObj = ldbMeIotObj_GetByAttrId(meIotObjs, disabledIots[idx].attrId);

		if (null != meIotObj)
		{
			return true;
		}
	}

	for (idx = 0; idx < enabledIots.length; idx++)
	{
		meIotObj = ldbMeIotObj_GetByAttrId(meIotObjs, enabledIots[idx].attrId);

		if (null == meIotObj)
		{
			return true;
		}
		else
		{
			if (meIotObj.value != enabledIots[idx].value)
			{
				return true;
			}
		}
	}
	
	return false;
}


function updateMeIotObjs(meIotObjs, enabledIots, disabledIots)
{
	var idx = 0;
	var meObj = null;
	var meIotObj = null;
	
	var meInstObj = null;
	
	meObj = ldbCurMeObj_Get();
	meInstObj = ldbCurMeInstObj_Get();
	
	for (idx = 0; idx < disabledIots.length; idx++)
	{
		meIotObj = ldbMeIotObj_GetByAttrId(meIotObjs, disabledIots[idx].attrId);

		if (null != meIotObj)
		{
			$.act(ACT_DEL, GPON_OMCI_ME_IOT, meIotObj.__stack, null);
		}
	}

	for (idx = 0; idx < enabledIots.length; idx++)
	{
		meIotObj = ldbMeIotObj_GetByAttrId(meIotObjs, enabledIots[idx].attrId);

		if (null == meIotObj)
		{
			meIotObj = new Object();
			meIotObj.meId = meObj.meId;
			meIotObj.instId = enabledIots[idx].instId;
			meIotObj.attrId = enabledIots[idx].attrId;
			meIotObj.value = enabledIots[idx].value;
			
			$.act(ACT_ADD, GPON_OMCI_ME_IOT, null, meInstObj.__stack, meIotObj);
		}
		else
		{
			var args = new Array();
			if (meIotObj.value != enabledIots[idx].value)
			{
				args.push("value=" + enabledIots[idx].value);
				$.act(ACT_SET, GPON_OMCI_ME_IOT, meIotObj.__stack, null, args);
			}
		}
	}
	
	if ($.as.length > 0)
	{
		return (!$.exe()) ? 1 : 0;
	}
	else
	{
		return 2;	
	}
}

function updateMeInstDesc(meInstObj)
{
	var args = new Array();
	args.push("instDesc=" + meInstObj.instDesc);
	$.act(ACT_SET, GPON_OMCI_ME_INST, meInstObj.__stack, null, args);
	return (!$.exe()) ? true : false;
}

function addMeInstObj(meObj, meInstObj)
{
	//var newMeInstObj = $.act(ACT_ADD, GPON_OMCI_ME_INST, null, meObj.__stack, meInstObj);
	var newMeInstObj = $.act(ACT_ADD, GPON_OMCI_ME_INST, null, null, meInstObj);
	return (!$.exe()) ? newMeInstObj : null;
}

function addMeIotObjs(meInstObj, meIotObjs)
{
	var idx = 0;
	var meIotObj = null;
	
	for (idx = 0; idx < meIotObjs.length; idx++)
	{
		meIotObj = meIotObjs[idx];
		$.act(ACT_ADD, GPON_OMCI_ME_IOT, null, meInstObj.__stack, meIotObj);
	}
	return (!$.exe()) ? true : false;
}

function loadMeInfo(meObj)
{
	if (null != meObj)
	{
		$.html($.id(ID_TD_ME_ID), null != meObj ? meObj.meId : STR_NOT_AVAILABLE);
		$.html($.id(ID_TD_ME_NAME), null != meObj ? meObj.meName : STR_NOT_AVAILABLE);
		$.html($.id(ID_TD_ME_DESC), null != meObj ? meObj.meDesc : STR_NOT_AVAILABLE);
	}
}

function loadMeAttr(meAttrObjs)
{
	if (null != meAttrObjs)
	{
		var rowId = 0;
		var table = $.id(ID_TBL_ME_ATTR);
		var meAttrObj = null;
		for (var idx = 0; idx < meAttrObjs.length; idx++)
		{
			meAttrObj = meAttrObjs[idx];
			buildMeAttrTableOneRow(table, meAttrObj);
			rowId++;
		}
	}
}

function loadMeInst(meInstObjs)
{
	if (null != meInstObjs)
	{
		var selMeInstId = null; 
		var txbMeInstDesc = null;
		var paraMeInstNone = null;
		var paraMeInstInfo = null;
		var meInstObj = null;
		var curMeInstObj = null;
		var val = null;
		var txt = null;
		var selIdx = 0;
		var idx = 0;

		selMeInstId = $.id(ID_SEL_ME_INST_ID);
		curMeInstObj = ldbCurMeInstObj_Get();
			
		if (meInstObjs.length > 0)
		{
			paraMeInstInfo = $.id(ID_PARA_ME_INST_INFO);
			$.removeClass(paraMeInstInfo, "nd");
			
			if (null == curMeInstObj)
			{
				curMeInstObj = 	meInstObjs[0];
				ldbCurMeInstObj_Set(curMeInstObj);
			}

			for (idx = 0; idx < meInstObjs.length; idx++)
			{
				meInstObj = meInstObjs[idx];
				val = meInstObj.instId;
				txt = meInstObj.instId;
				//alert("val = " + val + ", txt = " + txt);
				selMeInstId.options.add(new Option(txt, val));
				if (curMeInstObj.instId == meInstObj.instId)
				{
					selIdx = idx;	
				}
			}
			
			selMeInstId.selectedIndex = selIdx;
			$.id(ID_TXB_ME_INST_DESC).value = curMeInstObj.instDesc;
		}
		else
		{
			paraMeInstNone = $.id(ID_PARA_ME_INST_NONE);
			$.removeClass(paraMeInstNone, "nd");
		}
	}
}

function IsMeIotConfigHere(meIotObj)
{
	var meiot;
	
	for (var idx = 0; idx < l_dbMeIotConfigInDevInfo.length; idx++)
	{
		meiot = l_dbMeIotConfigInDevInfo[idx];
		if ( (meiot.meId == meIotObj.meId) && (meiot.attrId == meIotObj.attrId) )
		{
			return false;
		}
	}
	
	return true;
}

function loadMeIot(meIotObjs)
{
	var meAttrObjs = null;
	var meAttrObj = null;
	var html = "";
	var idx = 0;
		
	meAttrObjs = ldbMeAttrObjs_Get();

	for (idx = 0; idx < meAttrObjs.length; idx++)
	{
		meAttrObj = meAttrObjs[idx];
		tdMeIotEn = $.id(ID_TD_ME_IOT_EN + meAttrObj.attrId);
		tdMeIotVal = $.id(ID_TD_ME_IOT_VAL + meAttrObj.attrId);
		
		html = buildMeIotEnCheckbox(ID_CHKB_ME_IOT_EN + meAttrObj.attrId, meAttrObj.attrId, true, false, "meIotEnCheckboxClick");
		$.html(tdMeIotEn, html);
		
		html = buildMeIotValTxbOrSel(meAttrObj.type, meAttrObj.max, meAttrObj.min, meAttrObj.format, "", false, meAttrObj.attrId);
		$.html(tdMeIotVal, html);
	}
	
	if (null != meIotObjs)
	{
		var tdMeIotEn = null;
		var tdMeIotVal = null;
		
		var meIotObj = null;
		
		for (idx = 0; idx < meIotObjs.length; idx++)
		{
			meIotObj = meIotObjs[idx];
			
			tdMeIotEn = $.id(ID_TD_ME_IOT_EN + meIotObj.attrId);
			tdMeIotVal = $.id(ID_TD_ME_IOT_VAL + meIotObj.attrId);
			
			meAttrObj = ldbMeAttrObj_GetById(meAttrObjs, meIotObj.attrId);

			if (null != tdMeIotEn && null != tdMeIotVal && null != meAttrObj)
			{
				var IscfgHere = true;

				IscfgHere = IsMeIotConfigHere(meIotObj);
			
				html = buildMeIotEnCheckbox(ID_CHKB_ME_IOT_EN + meAttrObj.attrId, meAttrObj.attrId, IscfgHere, true, "meIotEnCheckboxClick");
				$.html(tdMeIotEn, html);
				
				html = buildMeIotValTxbOrSel(meAttrObj.type, meAttrObj.max, meAttrObj.min, meAttrObj.format, meIotObj.value, IscfgHere, meAttrObj.attrId);
				$.html(tdMeIotVal, html);
			}
		}
	}

	

}

function buildMeAttrTableOneRow(table, meAttrObj)
{
	var html;
	var row = table.insertRow(-1);
	
	cell = row.insertCell(-1);
	cell.id = ID_TD_ME_ATTR_ID + meAttrObj.attrId;
	$.html(cell, meAttrObj.attrId);
	
	cell = row.insertCell(-1);
	cell.id = ID_TD_ME_ATTR_NAME + meAttrObj.attrId;
	$.html(cell, meAttrObj.name);
	
	cell = row.insertCell(-1);
	cell.id = ID_TD_ME_ATTR_DESC + meAttrObj.attrId;
	cell.style.textAlign = "left";
	$.html(cell, meAttrObj.desc.replace(/;;/g, "<br/>").replace(/,,/g, "<span style=\"padding-left:10px\"/>"));
	
	cell = row.insertCell(-1);
	cell.id = ID_TD_ME_IOT_EN + meAttrObj.attrId;
	
	cell = row.insertCell(-1);
	cell.id = ID_TD_ME_IOT_VAL + meAttrObj.attrId;
	
	row.id = ID_ROW_ME_ATTR + meAttrObj.attrId;
}

function buildMeIotEnCheckbox(chkbId, attrId, enabled, checked, onchange)
{
	return '<input type="checkbox" id="' + chkbId + '" onclick = "' + onchange +'(this,' + attrId + ');"' + (enabled == false ? ' disabled = true ' : '') + (checked == true ? ' checked = true ' : '') + '/>';
}

function buildMeIotValTxbOrSel(type, max, min, format, value, enabled, attrId)
{
	var html = "unknow type";

	switch (type)
	{
	case IOT_ATTR_NUMBER:
		if (format == "" || format == "hex")
		{
			html = buildMeIotValTextbox(ID_TXB_ME_IOT_VAL + attrId, type, value, max, min, format, attrId, !enabled, "meIotValTxbBlur");
		}
		else
		{
			html = buildMeIotValSelect(ID_SEL_ME_IOT_VAL + attrId, format.split(","), format.split(","), value, attrId, !enabled, "meIotValSelChange");
		}
		break;

	case IOT_ATTR_ARRAY:
		if (format == "hex")
		{
			min = 2 * min;
			max = 2 * max;
		}
		html = buildMeIotValTextbox(ID_TXB_ME_IOT_VAL + attrId, type, value, max, min, format, attrId, !enabled, "meIotValTxbBlur");
		break;
		
	case IOT_ATTR_BOOLEAN:
		html = buildMeIotValSelect(ID_SEL_ME_IOT_VAL + attrId, ["false", "true"], ["0", "1"], 
																	value == "0" ? "false" : "true", attrId, !enabled, "meIotValSelChange");
		break;
		
	default:
		break;
	}
	
	return html;
}

function buildMeIotValTextbox(id, type, value, max, min, format, attrId, disabled, onchange)
{
	if (type == IOT_ATTR_NUMBER)
	{
		return '<input type="text" class="text L" style="width:100px"  id="' + id + '" value = "' + value + 
					'" onblur = \'return ' + onchange +'(this,' + type + ', ' + max + ',' + min + ',' + attrId + ', "' + format + '");\'' + 
					(disabled == true ? '" disabled = true' : '') + '/>';
	}
	else
	{
		if (max == 0)
		{
			max = IOT_ATTR_LEN_MAX;	
		}
		
		return '<input type="text" class="text L" style="width:100px"  id="' + id + '" value = "' + value + '" maxlength = "' + max +
					'" onblur = \'return ' + onchange +'(this,' + type + ', ' + max + ',' + min + ',' + attrId + ', "' + format + '");\'' + 
					(disabled == true ? '" disabled = true' : '') + '/>';
	}
}

function buildMeIotValSelect(id, selTxts, selVals, selVal, attrId, disabled, onchange)
{
	var selHtml = '<select id = "' + id  + '" class = "select" style="width:100px" onchange = \'' + 
					onchange + '(this, "' + selVal + '",' + attrId + ');\''+ (disabled == true ? '" disabled = true' : '') + '/>';
	var idx = 0;
	
	for (idx = 0; idx < selTxts.length; idx++)
	{
		selHtml += '<option ';
		
		if (null != selVals)
		{
			selHtml += 'value="'+ selVals[idx] + '"';
		}
		
		if (selVals[idx] == selVal)
		{
			selHtml += ' selected = "true"';	
		}
		
		selHtml += '>' + selTxts[idx] + '</option>';
	}
	
	selHtml += '</select>';

	return selHtml;
}

function meIotEnCheckboxClick(chkb, attrId)
{
	var txbMeIotVal = null;
	var selMeIotVal = null;
	var checked = chkb.checked;
	var xxxMeIotVal = null;
	
	txbMeIotVal = $.id(ID_TXB_ME_IOT_VAL + attrId);
	selMeIotVal = $.id(ID_SEL_ME_IOT_VAL + attrId);
	
	xxxMeIotVal = ((txbMeIotVal != null) ? txbMeIotVal : (selMeIotVal != null ? selMeIotVal : null));
	
	if (null == xxxMeIotVal)
	{
		return;
	}
	
	if (true == errFlag)
	{
		if (attrId != errAttrId)
		{
			chkb.checked = !checked;
			errEleFocus(errEle);
			return;
		}
		else
		{
			//errEle.value = $.h($.id(tdOldValPrefix + rowId));
			errFlag = false;	
			hideErrMsg();
		}
	}
	
	if (true == chkb.checked)
	{
		xxxMeIotVal.disabled = false;
		xxxMeIotVal.focus();
	}
	else
	{
		xxxMeIotVal.disabled = true;
	}
}

function meIotValTxbBlur(txb, type, max, min, attrId, format)
{
	var errMsg = "";

	if (true == txb.disabled)
	{
		return;
	}

	if ("" == txb.value)
	{	
		errMsg = "required";
	}
	else if (IOT_ATTR_NUMBER == type)
	{
		errMsg = numberValidation(txb.value, format, min, max);
	}
	else if (IOT_ATTR_ARRAY == type)
	{
		if (txb.value.length < min || txb.value.length > max)
		{
			errMsg = "length[" + min + "," + max + "]";
		}
		else if (arguments.length >= 5 && format != "")
		{
			var pattern;

			if (format == "hex")
			{
				pattern = /[^a-fA-F0-9]/g;
			}
			else
			{
				pattern = new RegExp(format);	
			}

			if (typeof txb.value === "string" && txb.value.match(pattern))
			{
				errMsg = "bad hex!";
			}
		}	
	}
	
	if (errMsg != "")
	{
		var td;
		errFlag = true;
		errEle = txb;
		errAttrId = attrId;
		td = $.id(ID_TD_ME_IOT_VAL + attrId);
		showErrMsg(td, errMsg);
		errEleFocus(errEle);
		return false;
	}
	else
	{
		errFlag = false;
		hideErrMsg();
		return true;
	}
}

function meIotValSelChange(sel, oldVal, attrId)
{
	if (errFlag == true)
	{
		for (var idx = 0; idx < sel.options.length; idx++)
		{
			if (oldVal == sel.options[idx].value)
			{
				sel.options[idx].selected = true;
				break;
			}
		}
		errEleFocus(errEle);
		return false;
	}
}

var selMeInstIdChangeByChange = false;
function selMeInstIdChange()
{
	var sel = null;
	var idx = 0;
	var curMeInstObj = null;
	
	sel = $.id(ID_SEL_ME_INST_ID);
	idx = sel.selectedIndex;
	ldbCurMeInstObj_Set(ldbMeInstObj_GetById(ldbMeInstObjs_Get(), sel.options[idx].value));
	curMeInstObj = ldbCurMeInstObj_Get();
	$.id(ID_TXB_ME_INST_DESC).value = curMeInstObj.instDesc;
	initMeIotObjs(curMeInstObj);
	loadMeIot(ldbMeIotObjs_Get());
}

function SaveOKNotify()
{
	//save iot xml to flash
	var iotcfglist = {};
	var cfg = $.act(ACT_GET, GPON_IOT_CFG, null, null, ["chooseIdx"]);
	if ($.exe())
	{
		return -1;
	}

	iot_list = $.act(ACT_GL, GPON_IOT_CFG_LIST, null, null);
	if ($.exe())
	{
		return -1;
	}
	
	var idx;
	var iotcfglistobj;
	for (idx = 0; idx < iot_list.length; idx++)
	{
		iotcfglistobj = iot_list[idx];
		if (cfg.chooseIdx == iotcfglistobj.cfgIdx)
		{
			$.act(ACT_SET, GPON_IOT_CFG_LIST, iotcfglistobj.__stack, null, ["cfgIdx=" + cfg.chooseIdx]);
			if ($.exe())
			{
				return -1;
			}
			
			return 0;
		}
	}
	
	return -1;
}

function btnSaveClick()
{
	var enabledIots = null;
	var disabledIots = null;
	var meIotObjs = null;
	var curMeInstObj = null;
	
	var hasUpdateMeInstDesc = false;
	var hasUpdateMeIot = false;
	
	var updateMeInstDescOk = false;
	var updateMeIotRet = 0;
	
	var saveOk = false;
	
	if (errFlag == true)
	{
		alert(MSG_HAS_ERR_BEFORE_SAVE);
		errEleFocus(errEle);
		return;
	}
	
	curMeInstObj = ldbCurMeInstObj_Get();
	meIotObjs = ldbMeIotObjs_Get();
	
	if (null == curMeInstObj)
	{
		return;
	}
	
	enabledIots = collectMeIotInfo(true, curMeInstObj.instId);
	disabledIots = collectMeIotInfo(false, curMeInstObj.instId);
		
	/*
	var idx = 0;
	for (idx = 0; idx < enabledIots.length; idx++)
	{
		alert("idx = " + idx + ", instId = " + enabledIots[idx].instId + ", attrId = " + enabledIots[idx].attrId + ", val = " + enabledIots[idx].value);	
	}
	for (idx = 0; idx < disabledIots.length; idx++)
	{
		alert("idx = " + idx + ", instId = " + disabledIots[idx].instId + ", attrId = " + disabledIots[idx].attrId + ", val = " + disabledIots[idx].value);	
	}
	*/
	
	if ($.id(ID_TXB_ME_INST_DESC).value != curMeInstObj.instDesc)
	{
		hasUpdateMeInstDesc = true;
		curMeInstObj.instDesc = $.id(ID_TXB_ME_INST_DESC).value;
		if (true == updateMeInstDesc(curMeInstObj))
		{
			updateMeInstDescOk = true;
		}
	}
	
	updateMeIotRet = updateMeIotObjs(meIotObjs, enabledIots, disabledIots);
		
	if (true == hasUpdateMeInstDesc)
	{
		if (true == updateMeInstDescOk && updateMeIotRet != 0)
		{
			saveOk = true;
		}
	}
	else
	{
		if (1 == updateMeIotRet)
		{
			saveOk = true;
		}
	}	
	
	if (true == saveOk)
	{
		if (!SaveOKNotify())
		{
			alert(MSG_SAVE_OK);
			localReload(ldbCurMeInstObj_Get());
		}
	}
}

function btnSaveNewMeInst()
{
	var meObj = null;
	var meInstObj = null;
	var newMeInstObj = null;
	var enabledIots = null;
	var meIotObj = null;
	var meIotObjs = new Array();
	var instId = 0;	
	var instDesc = "";
	var txbMeInstIdNew = null;
	var txbMeInstDescNew = null;

	var errmsg = "";
	
	var idx = 0;
	

	txbMeInstIdNew = $.id(ID_TXB_ME_INST_ID_NEW);
	txbMeInstDescNew = $.id(ID_TXB_ME_INST_DESC_NEW);
	
	errmsg = numberValidation(txbMeInstIdNew.value, "", ME_INST_ID_MIN, ME_INST_ID_MAX);
	if (errmsg != "")
	{
		alert(MSG_ME_INST_ID_ERR + errmsg);
		txbMeInstIdNew.focus();
		return;
	}
	
	instId = parseInt(txbMeInstIdNew.value);
	if (null != ldbMeInstObj_GetById(ldbMeInstObjs_Get(), instId))
	{
		alert(MSG_ME_INST_EXISTS);	
		txbMeInstIdNew.focus();
		return;
	}
	
	instDesc = txbMeInstDescNew.value;
	if (instDesc.length > ME_INST_DESC_LEN_MAX)
	{
		alert(MSG_ME_INST_DESC_TOO_LONG);	
		return;
	}
	
	if (errFlag == true)
	{
		alert(MSG_HAS_ERR_BEFORE_SAVE);
		errEleFocus(errEle);
		return;
	}
	
	meObj = ldbCurMeObj_Get();

	meInstObj = new Object();
	meInstObj.meId = meObj.meId;
	meInstObj.instId = instId;
	meInstObj.instDesc = instDesc;

	if (null != (newMeInstObj = addMeInstObj(meObj, meInstObj)))
	{
		enabledIots = collectMeIotInfo(true, newMeInstObj.instId);
		for (idx = 0; idx < enabledIots.length; idx++)
		{
			meIotObj = new Object();
			meIotObj.meId = meObj.meId;
			meIotObj.instId = enabledIots[idx].instId;
			meIotObj.attrId = enabledIots[idx].attrId;
			meIotObj.value = enabledIots[idx].value;
			meIotObjs.push(meIotObj);
		}
		
		if (true == addMeIotObjs(newMeInstObj, meIotObjs))
		{
			if (!SaveOKNotify())
			{
				alert(MSG_ADD_OK);
				localReload();
			}		
		}
	}
}

function btnCancelClick()
{
	var paraMeInstNone = null;
	var paraMeInstInfo = null;
	var paraMeInstNew = null;
	var txbMeInstIdNew = null;
	var selMeInstId = null;
	var btnAdd = null;
	var btnDel = null;
	var btnBack = null;
	var btnSave = null;

	errFlag = false;
	hideErrMsg();
	
	paraMeInstNone = $.id(ID_PARA_ME_INST_NONE);
	paraMeInstInfo = $.id(ID_PARA_ME_INST_INFO);
	paraMeInstNew = $.id(ID_PARA_ME_INST_NEW);

	btnAdd = $.id(ID_BTN_ADD);
	btnDel = $.id(ID_BTN_DEL);
	btnBack = $.id(ID_BTN_BACK);
	btnSave = $.id(ID_BTN_SAVE);
	
	
	if (null == ldbCurMeInstObj_Get())
	{
		if ($.hasClass(paraMeInstNone, "nd"))
		{
	   		$.removeClass(paraMeInstNone, "nd");
		}
	}
	else
	{
		if ($.hasClass(paraMeInstInfo, "nd"))
		{
			$.removeClass(paraMeInstInfo, "nd");
		}	
	}
	
	if (!$.hasClass(paraMeInstNew, "nd"))
	{
		$.addClass(paraMeInstNew, "nd");
	}

	btnAdd.value = STR_BTN_ADD;
	btnAdd.onclick = btnAddClick;
	
	$.removeClass(btnDel, "nd");
	$.removeClass(btnBack, "nd");
	
	btnSave.onclick = btnSaveClick;
	
	loadMeIot(ldbMeIotObjs_Get());
}

function btnAddClick()
{
	var paraMeInstNone = null;
	var paraMeInstInfo = null;
	var paraMeInstNew = null;
	
	var btnAdd = null;
	var btnDel = null;
	var btnBack = null;
	var btnSave = null;
	
	var txbMeInstIdNew = null;
	
	if (errFlag == true)
	{
		alert(MSG_HAS_ERR_BEFORE_ADD);
		errEleFocus(errEle);
		return;
	}
	
	paraMeInstNone = $.id(ID_PARA_ME_INST_NONE);
	paraMeInstInfo = $.id(ID_PARA_ME_INST_INFO);
	paraMeInstNew = $.id(ID_PARA_ME_INST_NEW);
	txbMeInstIdNew = $.id(ID_TXB_ME_INST_ID_NEW);
	
	btnAdd = $.id(ID_BTN_ADD);
	btnDel = $.id(ID_BTN_DEL);
	btnBack = $.id(ID_BTN_BACK);
	btnSave = $.id(ID_BTN_SAVE);

	if (!$.hasClass(paraMeInstNone, "nd"))
	{
	   $.addClass(paraMeInstNone, "nd");
	}
	
	if (!$.hasClass(paraMeInstInfo, "nd"))
	{
	   $.addClass(paraMeInstInfo, "nd");
	}
	
	if ($.hasClass(paraMeInstNew, "nd"))
	{
		$.removeClass(paraMeInstNew, "nd");
	}
	
	btnAdd.value = STR_BTN_CANCEL;
	btnAdd.onclick = btnCancelClick;
	
	$.addClass(btnDel, "nd");
	$.addClass(btnBack, "nd");
	
	btnSave.onclick = btnSaveNewMeInst;
	
	txbMeInstIdNew.focus();
	
	loadMeIot(null);
}

function btnDelClick()
{
	var curMeInstObj = null;
	curMeInstObj = ldbCurMeInstObj_Get();
	
	if (curMeInstObj != null && confirm(MSG_DEL_CONFIRM))
	{
		$.act(ACT_DEL, GPON_OMCI_ME_INST, curMeInstObj.__stack, null);
		if (! $.exe())
		{
			/* alert(MSG_DEL_OK); */
			localReload();
		}
	}
}

function btnBackClick()
{
	if (true == curMeIotChanged())
	{
		if (!confirm(MSG_BACK_CONFIRM))
		{
			return;
		}
	}
	
	$.loadMain(PREV_PAGE)
}

function curMeIotChanged()
{
	var enabledIots = null;
	var disabledIots = null;
	var meIotObjs = null;
	var curMeInstObj = null;
	
	curMeInstObj = ldbCurMeInstObj_Get();
	meIotObjs = ldbMeIotObjs_Get();
	
	if (null == curMeInstObj)
	{
		return;
	}
	
	if ($.id(ID_TXB_ME_INST_DESC).value != curMeInstObj.instDesc)
	{
		return true;
	}

	enabledIots = collectMeIotInfo(true, curMeInstObj.instId);
	disabledIots = collectMeIotInfo(false, curMeInstObj.instId);
	
	return meIotObjsChanged(meIotObjs, enabledIots, disabledIots);
}

function collectMeIotInfo(checked, instId)
{
	var results = new Array();
	var result = null;
	var meAttrObjs = ldbMeAttrObjs_Get();
	var chkbMeIotEn = null;
	var txbMeIotVal = null;
	var selMeIotVal = null;
	var meAttrObj = null;
	var idx = 0;
	
	for (idx = 0; idx < meAttrObjs.length ; idx++)
	{
		meAttrObj = meAttrObjs[idx];
		chkbMeIotEn = $.id(ID_CHKB_ME_IOT_EN + meAttrObj.attrId);
		txbMeIotVal = $.id(ID_TXB_ME_IOT_VAL + meAttrObj.attrId);
		selMeIotVal = $.id(ID_SEL_ME_IOT_VAL + meAttrObj.attrId);
		
		if (null != chkbMeIotEn)
		{
			if (checked == chkbMeIotEn.checked)
			{
				result = new Object();
				result.attrId = meAttrObj.attrId;
				if (null != txbMeIotVal)
				{
					result.value = txbMeIotVal.value;	
				}
				else if (null != selMeIotVal)
				{
					result.value = selMeIotVal.options[selMeIotVal.selectedIndex].value;
				}
				else
				{
					result.value = "";	
				}
				result.instId = instId;
				results.push(result);
			}
		}
	}
	
	return results;
}

function localReload(curMeInstObj)
{
	var param = [];
	param[0] = ldbCurMeObj_Get();
	if (curMeInstObj != null)
	{
		param[1] = curMeInstObj;	
	}
	$.loadMain(THIS_PAGE, param);
}

init();
</script>

<p class="et T" id="et">GPON OMCI ME IOT Attribute Edit Page</p>
<div class="con1 XXXL">
<p class="ct"></p>
<p class="bl"></p>
<div class="con2">
<p class="L1 T" id="t_info">ME Information</p>
<table id="tblMeInfo" class="tc bdr XL" align="center" cellspacing="0" cellpadding="0">
<tr>
	<th width="200" class="T" id="">ME ID</th>
	<td class="T" id="tdMeId"></td>
</tr>
<tr>
	<th width="200" class="T" id="">ME Name</th>
	<td class="T" id="tdMeName"></td>
</tr>
<tr>
	<th width="200" class="T" id="">ME Description</th>
	<td class="T" id="tdMeDesc"></td>
</tr>
</table>
</div>

<div id="divErrMsg" style="position:absolute; color:#F00; font-weight:bold; width:100px" class="nd"></div>

<p class="ct"></p>
<p class="bl"></p>
<div class="con2">
<p class="L1 T nd" id="paraMeInstNone">You can click 【Add】 button to add a new instance.</p>
<p class="L1 T nd" id="paraMeInstInfo">
	Instance Number:
	<select id="selMeInstId" style="width:68px" onchange="selMeInstIdChange();"></select>
    
    Instance Description:
    <input id="txbMeInstDesc" class="text L" maxlength="63" style="width:480px">
</p>
<p class="L1 T nd" id="paraMeInstNew">
	Instance Number:
    <input id="txbMeInstIdNew"  class="text L" maxlength="5" style="width:60px;"/>
    
    Instance Description:
    <input id="txbMeInstDescNew" class="text L" maxlength="63" style="width:480px">
</p>
<p class="br"></p>
<table id="tblMeAttr" class="tc bdr XL" align="center" cellspacing="0" cellpadding="0">
<tr>
    <th class="T" id="" style="width:50px">ID</th>
	<th class="T" id="" style="width:200px">Name</th>
	<th class="T" id="">Description</th>
    <th class="T" id="" style="width:50px">IOT Enabled</th>
    <th class="T" id="" style="width:100px">IOT Value</th>
</tr></table>
</div>

<p class="bl"></p>
<p class="tail">
<input type="button" id="btnSave" class="button L" value="Save" onclick="btnSaveClick();" />
<input type="button" id="btnAdd" class="button L" value="Add" onclick="btnAddClick();" />
<input type="button" id="btnDel" class="button L" value="Delete" onclick="btnDelClick();" />
<input type="button" id="btnBack" class="button L" value="Back" onclick="btnBackClick();" />
</p>
</div>